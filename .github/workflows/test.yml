name: Test

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        emacs-version:
          - '29.1'
          - '29.4'
          - 'snapshot'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: ${{ matrix.emacs-version }}

      - name: Cache ELPA packages
        uses: actions/cache@v4
        with:
          path: ~/.emacs.d/elpa
          key: elpa-${{ runner.os }}-${{ matrix.emacs-version }}-${{ hashFiles('*.el') }}
          restore-keys: |
            elpa-${{ runner.os }}-${{ matrix.emacs-version }}-
            elpa-${{ runner.os }}-

      - name: Install dependencies
        run: |
          emacs -batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'gptel)" \
            --eval "(package-install 'compat)" \
            --eval "(package-install 'yaml)"

      - name: Byte-compile
        run: |
          emacs -batch \
            -L . \
            --eval "(setq byte-compile-error-on-warn t)" \
            -f batch-byte-compile \
            gptel-agent.el \
            gptel-agent-tools.el \
            gptel-agent-tools-introspection.el \
            gptel-agent-permissions.el \
            gptel-agent-safety.el \
            gptel-agent-compaction.el

      - name: Run ERT tests
        run: |
          emacs -batch \
            -L . \
            -L test \
            -l ert \
            -l test/test-helper.el \
            -l test/gptel-agent-permissions-test.el \
            -l test/gptel-agent-safety-test.el \
            -l test/gptel-agent-compaction-test.el \
            -f ert-run-tests-batch-and-exit

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.emacs-version }}
          path: |
            *.log
            test/*.log
